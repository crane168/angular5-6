{"version":3,"file":"countdown.umd.min.js","sources":["../../__gen_lib/components/timer.ts","../../__gen_lib/components/component.ts","../../__gen_lib/ngx-countdown.module.ts"],"sourcesContent":["import { Injectable } from '@angular/core';\n\n@Injectable()\nexport class Timer {\n  private fns: any[] = [];\n  private commands: Function[] = [];\n  private nextTime: number;\n  private ing = false;\n\n  start() {\n    if (this.ing === true) return;\n\n    this.ing = true;\n    this.nextTime = +new Date();\n    this.process();\n  }\n\n  private process() {\n    while (this.commands.length) {\n      this.commands.shift()();\n    }\n    let diff = +new Date() - this.nextTime;\n    const count = 1 + Math.floor(diff / 100);\n\n    diff = 100 - diff % 100;\n    this.nextTime += 100 * count;\n\n    let frequency: number, step: number, i: number, len: number;\n    for (i = 0, len = this.fns.length; i < len; i += 2) {\n      frequency = this.fns[i + 1];\n\n      // 100/s\n      if (0 === frequency) {\n        this.fns[i](count);\n        // 1000/s\n      } else {\n        // 先把末位至0，再每次加2\n        frequency += 2 * count - 1;\n\n        step = Math.floor(frequency / 20);\n        if (step > 0) {\n          this.fns[i](step);\n        }\n\n        // 把末位还原成1\n        this.fns[i + 1] = frequency % 20 + 1;\n      }\n    }\n\n    if (this.ing)\n      setTimeout(() => {\n        this.process();\n      }, diff);\n  }\n\n  add(fn: Function, frequency: number) {\n    this.commands.push(() => {\n      this.fns.push(fn);\n      this.fns.push(frequency === 1000 ? 1 : 0);\n      this.ing = this.fns.length > 0;\n    });\n  }\n\n  remove(fn: Function) {\n    this.commands.push(() => {\n      const i = this.fns.indexOf(fn);\n      if (i !== -1) {\n        this.fns.splice(i, 2);\n      }\n      this.ing = this.fns.length > 0;\n    });\n  }\n}\n","import {\n  Component,\n  ElementRef,\n  Input,\n  Renderer,\n  OnChanges,\n  SimpleChanges,\n  OnDestroy,\n  Output,\n  EventEmitter,\n  OnInit,\n  SimpleChange,\n} from '@angular/core';\nimport { Config } from './interfaces/config';\nimport { Hand } from './interfaces/hand';\nimport { Timer } from './timer';\n\n@Component({\n  selector: 'countdown',\n  template: `<ng-content></ng-content>`,\n  styles: [`:host { display: none; }`],\n  host: { '[class.count-down]': 'true' },\n})\nexport class CountdownComponent implements OnInit, OnChanges, OnDestroy {\n  private frequency = 1000;\n  private _notify: any = {};\n  private hands: Hand[] = [];\n  private left = 0;\n  private paused = false;\n  /** 两种情况会触发：时间终止或调用 `stop()` */\n  private stoped = false;\n\n  @Input() config: Config;\n  @Output() start = new EventEmitter();\n  @Output() finished = new EventEmitter();\n  @Output() notify = new EventEmitter();\n  @Output() event = new EventEmitter<{ action: string; left: number }>();\n\n  constructor(\n    private el: ElementRef,\n    private renderer: Renderer,\n    private timer: Timer,\n  ) {\n    this.timer.start();\n  }\n\n  /** 开始，当 `demand: false` 时触发 */\n  begin() {\n    this.paused = false;\n    this.start.emit();\n    this.callEvent('start');\n  }\n\n  /** 重新开始 */\n  restart(): void {\n    if (!this.stoped) this.destroy();\n    this.init();\n    this.timer.start();\n    this.callEvent('restart');\n  }\n\n  /** 停止 */\n  stop() {\n    if (this.stoped) return;\n    this.stoped = true;\n    this.destroy();\n    this.callEvent('stop');\n  }\n\n  /** 暂停（限未终止有效） */\n  pause() {\n    if (this.stoped || this.paused) return;\n    this.paused = true;\n    this.callEvent('pause');\n  }\n\n  /** 恢复 */\n  resume() {\n    if (this.stoped || !this.paused) return;\n    this.paused = false;\n    this.callEvent('resume');\n  }\n\n  private mergeConfig() {\n    this.config = Object.assign(\n      <Config>{\n        demand: false,\n        leftTime: 0,\n        template: '$!h!时$!m!分$!s!秒',\n        effect: 'normal',\n        varRegular: /\\$\\!([\\-\\w]+)\\!/g,\n        clock: ['d', 100, 2, 'h', 24, 2, 'm', 60, 2, 's', 60, 2, 'u', 10, 1],\n      },\n      this.config,\n    );\n  }\n\n  private callEvent(action: string) {\n    this.event.emit({ action, left: this.left });\n  }\n\n  private init() {\n    const me = this;\n    const el = me.el.nativeElement;\n    me.paused = me.config.demand;\n    me.stoped = false;\n\n    // 分析markup\n    const tmpl = el.innerHTML || me.config.template;\n    me.config.varRegular.lastIndex = 0;\n    el.innerHTML = tmpl.replace(\n      me.config.varRegular,\n      (str: string, type: string) => {\n        // 时钟频率校正.\n        if (type === 'u' || type === 's-ext') me.frequency = 100;\n\n        // 生成hand的markup\n        let content = '';\n        if (type === 's-ext') {\n          me.hands.push({ type: 's' });\n          me.hands.push({ type: 'u' });\n          content =\n            me.html('', 's', 'handlet') +\n            me.html('.', '', 'digital') +\n            me.html('', 'u', 'handlet');\n        } else {\n          me.hands.push({ type: type });\n        }\n\n        return me.html(content, type, 'hand');\n      },\n    );\n\n    const clock = me.config.clock;\n    me.hands.forEach((hand: Hand) => {\n      const type = hand.type;\n      let base = 100,\n        i: number;\n\n      hand.node = el.querySelector(`.hand-${type}`);\n      // radix, bits 初始化\n      for (i = clock.length - 3; i > -1; i -= 3) {\n        if (type === clock[i]) {\n          break;\n        }\n\n        base *= clock[i + 1];\n      }\n      hand.base = base;\n      hand.radix = clock[i + 1];\n      hand.bits = clock[i + 2];\n    });\n\n    me.getLeft();\n    me.reflow(0, true);\n\n    // bind reflow to me\n    const _reflow = me.reflow;\n    me.reflow = (count: number = 0) => {\n      return _reflow.apply(me, [count]);\n    };\n\n    // 构建 notify\n    if (me.config.notify) {\n      me.config.notify.forEach((time: number) => {\n        if (time < 1)\n          throw new Error(`the notify config must be a positive integer.`);\n        time = time * 1000;\n        time = time - time % me.frequency;\n        me._notify[time] = true;\n      });\n    }\n\n    me.timer.add(me.reflow, me.frequency);\n    // show\n    el.style.display = 'inline';\n\n    return me;\n  }\n\n  private destroy() {\n    this.timer.remove(this.reflow);\n    return this;\n  }\n\n  /**\n   * 更新时钟\n   */\n  private reflow(count: number = 0, force: boolean = false): void {\n    if (!force && (this.paused || this.stoped)) return;\n    const me = this;\n    me.left = me.left - me.frequency * count;\n\n    me.hands.forEach((hand: Hand) => {\n      hand.lastValue = hand.value;\n      hand.value = Math.floor(me.left / hand.base) % hand.radix;\n    });\n\n    me.repaint();\n\n    if (me._notify[me.left]) {\n      me.notify.emit(me.left);\n      this.callEvent('notify');\n    }\n\n    if (me.left < 1) {\n      me.finished.emit(0);\n      this.stoped = true;\n      this.callEvent('finished');\n      this.destroy();\n    }\n  }\n\n  /**\n   * 重绘时钟\n   */\n  private repaint(): void {\n    const me = this;\n    if (me.config.repaint) {\n      me.config.repaint.apply(me);\n      return;\n    }\n\n    let content: string;\n\n    me.hands.forEach((hand: Hand) => {\n      if (hand.lastValue !== hand.value) {\n        content = '';\n\n        me.toDigitals(hand.value, hand.bits).forEach((digital: number) => {\n          content += me.html(digital.toString(), '', 'digital');\n        });\n\n        hand.node.innerHTML = content;\n      }\n    });\n  }\n\n  /**\n   * 获取倒计时剩余帧数\n   */\n  private getLeft(): void {\n    let left: number = this.config.leftTime * 1000;\n    const end: number = this.config.stopTime;\n\n    if (!left && end) left = end - new Date().getTime();\n\n    this.left = left - left % this.frequency;\n  }\n\n  /**\n   * 生成需要的html代码，辅助工具\n   */\n  private html(con: string, className: string, type: string): string {\n    switch (type) {\n      case 'hand':\n      case 'handlet':\n        className = type + ' hand-' + className;\n        break;\n      case 'digital':\n        if (con === '.') {\n          className = type + ' ' + type + '-point ' + className;\n        } else {\n          className = type + ' ' + type + '-' + con + ' ' + className;\n        }\n        break;\n    }\n    return '<span class=\"' + className + '\">' + con + '</span>';\n  }\n\n  /**\n   * 把值转换为独立的数字形式\n   */\n  private toDigitals(value: number, bits: number): number[] {\n    value = value < 0 ? 0 : value;\n    const digitals = [];\n    // 把时、分、秒等换算成数字.\n    while (bits--) {\n      digitals[bits] = value % 10;\n      value = Math.floor(value / 10);\n    }\n    return digitals;\n  }\n\n  ngOnInit() {\n    this.mergeConfig();\n    this.init();\n    if (!this.config.demand) this.begin();\n  }\n\n  ngOnDestroy(): void {\n    this.destroy();\n  }\n\n  ngOnChanges(\n    changes: { [P in keyof this]?: SimpleChange } & SimpleChanges,\n  ): void {\n    if (!changes.config.firstChange) {\n      this.mergeConfig();\n      this.destroy().init();\n    }\n  }\n}\n","import { CommonModule } from '@angular/common';\nimport { NgModule } from '@angular/core';\n\nimport { CountdownComponent } from './components/component';\nimport { Timer } from './components/timer';\n\n@NgModule({\n    imports:        [CommonModule],\n    providers:      [Timer],\n    declarations:   [CountdownComponent],\n    exports:        [CountdownComponent]\n})\nexport class CountdownModule {\n}\n"],"names":["Timer","this","ing","nextTime","Date","process","commands","length","shift","frequency","step","i","len","diff","count","Math","floor","fns","setTimeout","_this","fn","push","indexOf","splice","Injectable","el","renderer","timer","EventEmitter","start","CountdownComponent","paused","emit","callEvent","stoped","destroy","init","config","Object","assign","demand","leftTime","template","effect","varRegular","clock","action","event","left","me","nativeElement","tmpl","innerHTML","lastIndex","replace","str","type","content","hands","html","forEach","hand","base","node","querySelector","radix","bits","getLeft","reflow","_reflow","apply","notify","time","Error","_notify","add","style","display","remove","force","lastValue","value","repaint","finished","toDigitals","digital","toString","end","stopTime","getTime","con","className","digitals","mergeConfig","begin","changes","firstChange","Component","selector","styles","host","[class.count-down]","ElementRef","Renderer","Input","Output","NgModule","imports","CommonModule","providers","declarations","exports"],"mappings":"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"}